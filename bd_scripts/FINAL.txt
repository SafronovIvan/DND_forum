
CREATE TYPE party_status AS ENUM (
    'На одобрении',
    'Набор открыт',
    'Набор закрыт',
    'В процессе',
    'Завершена'
);

CREATE TYPE queue_status AS ENUM (
    'Принят',
    'Отклонён'
);

CREATE TABLE users (
	"id" SERIAL PRIMARY KEY,
	"username" VARCHAR(50) UNIQUE NOT NULL,
	"password_hash" VARCHAR(300) NOT NULL,
	"email" VARCHAR(100) UNIQUE NOT NULL,
	"priority_score" INTEGER DEFAULT 10,
	"created_at"  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "is_moder" BOOLEAN DEFAULT False
);

CREATE TABLE characters (
    "id" SERIAL PRIMARY KEY,
    "user_id" INTEGER REFERENCES users(id) ON DELETE CASCADE,
    "name" VARCHAR(50) UNIQUE NOT NULL,
    "level" INTEGER DEFAULT 1 CHECK (level BETWEEN 1 AND 20),
    "short_description" VARCHAR(50) NOT NULL,
    "long_description" VARCHAR(5000),
    "image_address" VARCHAR(500),
    "created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "is_active" BOOLEAN DEFAULT TRUE
);

CREATE TABLE parties (
	"id" SERIAL PRIMARY KEY,
    "dm_id" INTEGER REFERENCES users(id) ON DELETE SET NULL,
    "title" VARCHAR(50) NOT NULL,
    "description" TEXT NOT NULL,
    "min_players" INTEGER DEFAULT 3 CHECK (min_players BETWEEN 1 AND 99),
    "max_players" INTEGER DEFAULT 5 CHECK (max_players BETWEEN 1 AND 99),
    CHECK (max_players >= min_players),
    "status" party_status DEFAULT 'На одобрении',
    "schedule_date" DATE NOT NULL,
    "schedule_time" TIME NOT NULL,
    "location" VARCHAR(500) NOT NULL,
    "image_address" VARCHAR(500),
    "min_player_level" INTEGER DEFAULT 1 CHECK (min_player_level BETWEEN 1 AND 20),
    "max_player_level" INTEGER DEFAULT 1 CHECK (max_player_level BETWEEN 1 AND 20),
    CHECK (max_player_level >= min_player_level),
    "created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE registrations (
	"id" SERIAL PRIMARY KEY,
	"party_id" INTEGER REFERENCES parties(id) ON DELETE CASCADE,
	"character_id" INTEGER REFERENCES characters(id) ON DELETE CASCADE,
	"status" queue_status DEFAULT 'Отклонён',
	"applied_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)

